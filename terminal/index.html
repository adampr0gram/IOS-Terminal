<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>iOS Terminal</title>

<link rel="manifest" href="/manifest.json">

<!-- iOS PWA support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="/icons/192.png">

<!-- Xterm -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css">
<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>

<style>
    html, body {
        margin: 0;
        padding: env(safe-area-inset-top) env(safe-area-inset-right)
                 env(safe-area-inset-bottom) env(safe-area-inset-left);
        width: 100%;
        height: 100%;
        font-family: monospace;
        background: black;
        overflow: hidden;
    }
    #terminal {
        width: 100%;
        height: 100%;
    }

    /* Folder Picker Popup */
    #permissionPopup {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    #popupBox {
        background: #111;
        padding: 18px;
        border-radius: 12px;
        width: 260px;
        color: white;
        text-align: center;
        border: 1px solid #333;
    }
    #chooseFolder {
        background: #007aff;
        padding: 10px;
        width: 100%;
        margin-top: 10px;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
    }
</style>
</head>

<body>

<div id="terminal"></div>

<div id="permissionPopup">
    <div id="popupBox">
        <h3>Folder Access</h3>
        <p>Select a folder for file commands.</p>
        <button id="chooseFolder">Choose Folder</button>
    </div>
</div>

<script>
//
// XTERM INIT
//
const term = new Terminal({
    theme: { background: "#000000", foreground: "#ffffff" },
    cursorBlink: true
});

let dirHandle = null;

term.open(document.getElementById("terminal"));
term.write("iOS Terminal Ready\n");

//
// Try restoring folder permission
//
(async () => {
    const saved = localStorage.getItem("dir_saved");

    if (saved) {
        try {
            dirHandle = await window.showDirectoryPicker();
        } catch {
            /* user may have revoked permission */ 
        }
    }

    if (dirHandle) {
        document.getElementById("permissionPopup").style.display = "none";
        term.write("Folder permission restored.\n\n$ ");
    } else {
        term.write("Waiting for folder permission...\n");
    }
})();

//
// Folder selection button
//
document.getElementById("chooseFolder").onclick = async () => {
    try {
        dirHandle = await window.showDirectoryPicker();
        await dirHandle.requestPermission({ mode: "readwrite" });

        localStorage.setItem("dir_saved", "yes");

        document.getElementById("permissionPopup").style.display = "none";
        term.write("\nFolder selected.\n$ ");
    } catch {
        term.write("\nPermission denied.\n$ ");
    }
};

//
// Basic Terminal Input
//
let buffer = "";

term.onData(data => {
    if (data === "\r") {
        handleCommand(buffer.trim());
        buffer = "";
        term.write("\n$ ");
    } else if (data === "\u007F") {
        if (buffer.length) {
            buffer = buffer.slice(0, -1);
            term.write("\b \b");
        }
    } else {
        buffer += data;
        term.write(data);
    }
});

//
// Command Handler
//
async function handleCommand(cmd) {
    if (cmd === "") return;

    switch (cmd) {
        case "help":
            term.write("Commands: help, ls, dir, cls, echo, exit");
            break;

        case "cls":
            term.clear();
            break;

        case "ls":
        case "dir":
            if (!dirHandle) return term.write("No folder selected.");
            for await (const entry of dirHandle.values()) {
                term.write("\n" + entry.name);
            }
            break;

        case "exit":
            term.write("Goodbye.");
            break;

        default:
            if (cmd.startsWith("echo ")) {
                term.write(cmd.substring(5));
                break;
            }
            term.write("Unknown command");
    }
}

//
// Register Service Worker
//
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js");
}
</script>

</body>
</html>
