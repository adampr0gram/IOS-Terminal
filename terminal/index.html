<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>iOS Terminal</title>

<link rel="manifest" href="/manifest.json">

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="/icons/192.png">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">

<!-- Xterm -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css">
<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>

<style>
    html, body {
        margin: 0;
        padding: env(safe-area-inset-top) env(safe-area-inset-right)
                 env(safe-area-inset-bottom) env(safe-area-inset-left);
        width: 100%;
        height: 100%;
        background: #000000;
        overflow: hidden;
        font-family: "JetBrains Mono", monospace;
    }

    #terminal {
        width: 100%;
        height: 100%;
    }

    /* Popup */
    #permissionPopup {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.88);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    #popupBox {
        background: #0f0f0f;
        padding: 20px;
        width: 280px;
        border-radius: 10px;
        border: 1px solid #333;
        color: #e6e6e6;
        text-align: center;
        font-family: "JetBrains Mono", monospace;
    }
    #chooseFolder {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border: none;
        border-radius: 6px;
        background: #007aff;
        color: white;
        font-size: 16px;
    }
</style>
</head>

<body>

<div id="terminal"></div>

<div id="permissionPopup">
    <div id="popupBox">
        <h3>Folder Access</h3>
        <p>Please choose a folder so commands can read/write files.</p>
        <button id="chooseFolder">Choose Folder</button>
    </div>
</div>

<script>
/* ---------------- Terminal Setup ---------------- */

const term = new Terminal({
    theme: {
        background: "#000000",
        foreground: "#e0e0e0",
        cursor: "#ffffff"
    },
    fontFamily: "JetBrains Mono, monospace",
    fontSize: 16,
    cursorBlink: true,
    lineHeight: 1.2
});

let dirHandle = null;
let currentPath = "/";
let buffer = "";

/* Display Terminal */
term.open(document.getElementById("terminal"));
term.writeln("iOS Terminal Ready\n");
term.write("$ ");

/* ---------------- Folder Restore ---------------- */

(async () => {
    const saved = localStorage.getItem("dir_saved");

    if (saved) {
        try {
            dirHandle = await window.showDirectoryPicker();
        } catch {}
    }

    if (dirHandle) {
        document.getElementById("permissionPopup").style.display = "none";
        term.writeln("Folder permission restored.");
        term.write("$ ");
    } else {
        term.writeln("Waiting for folder permission...");
    }
})();

/* ---------------- Folder Picker ---------------- */

document.getElementById("chooseFolder").onclick = async () => {
    try {
        dirHandle = await window.showDirectoryPicker();
        await dirHandle.requestPermission({ mode: "readwrite" });
        localStorage.setItem("dir_saved", "yes");
        document.getElementById("permissionPopup").style.display = "none";
        term.writeln("\nFolder selected.");
        term.write("$ ");
    } catch {
        term.writeln("\nPermission denied.");
        term.write("$ ");
    }
};

/* ---------------- Input Handling ---------------- */

term.onData(data => {
    if (data === "\r") {
        const cmd = buffer.trim();
        buffer = "";
        term.write("\n");
        handleCommand(cmd);
        term.write("\n$ ");
    } else if (data === "\u007F") {
        if (buffer.length > 0) {
            buffer = buffer.slice(0, -1);
            term.write("\b \b");
        }
    } else {
        buffer += data;
        term.write(data);
    }
});

/* ---------------- Command Engine ---------------- */

async function handleCommand(cmd) {
    if (!cmd) return;

    const parts = cmd.split(" ");
    const base = parts[0];
    const args = parts.slice(1);

    switch (base) {
        case "help":
            term.writeln("Commands:");
            term.writeln(" help           - this help");
            term.writeln(" ls/dir        - list files");
            term.writeln(" cd <folder>   - change directory");
            term.writeln(" mkdir <name>  - create folder");
            term.writeln(" rmdir <name>  - remove folder");
            term.writeln(" del <file>    - delete file");
            term.writeln(" cls           - clear screen");
            term.writeln(" spec          - device specs");
            term.writeln(" echo <text>   - print");
            term.writeln(" ping <host>   - fake ping");
            term.writeln(" web <url>     - open URL");
            term.writeln(" credits       - show credits");
            term.writeln(" run <file>    - run .cipt script");
            term.writeln(" base64en      - encode file/text");
            term.writeln(" exit          - exit");
            break;

        case "cls":
            term.clear();
            break;

        case "ls":
        case "dir":
            if (!dirHandle) return term.writeln("No folder selected.");
            for await (const entry of dirHandle.values()) {
                term.writeln(entry.name);
            }
            break;

        case "cd":
            if (!args[0]) return term.writeln("Usage: cd <folder>");
            term.writeln("(cd is simulated only)");
            break;

        case "mkdir":
            if (!dirHandle) return term.writeln("No folder selected.");
            if (!args[0]) return term.writeln("Usage: mkdir <name>");
            await dirHandle.getDirectoryHandle(args[0], { create: true });
            term.writeln("Folder created.");
            break;

        case "rmdir":
            if (!args[0]) return term.writeln("Usage: rmdir <name>");
            await dirHandle.removeEntry(args[0], { recursive: true });
            term.writeln("Folder removed.");
            break;

        case "del":
            if (!args[0]) return term.writeln("Usage: del <file>");
            await dirHandle.removeEntry(args[0]);
            term.writeln("File deleted.");
            break;

        case "ping":
            term.writeln("Pinging " + args[0] + "...");
            await new Promise(r => setTimeout(r, 500));
            term.writeln("Reply from " + args[0] + ": bytes=32 time=32ms");
            break;

        case "echo":
            term.writeln(args.join(" "));
            break;

        case "web":
            if (!args[0]) return term.writeln("Usage: web <url>");
            window.open(args[0], "_blank");
            term.writeln("Opened " + args[0]);
            break;

        case "spec":
            term.writeln("Device: iOS WebKit");
            term.writeln("UserAgent: " + navigator.userAgent);
            term.writeln("Cores: " + navigator.hardwareConcurrency);
            break;

        case "credits":
            term.writeln("Adam T. Nassar");
            break;

        case "run":
            term.writeln("CIPT execution coming soon!");
            break;

        case "base64en":
            term.writeln("Feature soon: base64 encode file/text");
            break;

        case "exit":
            term.writeln("Goodbye!");
            break;

        default:
            term.writeln("Unknown command: " + base);
    }
}

/* ---------------- PWA Service Worker ---------------- */

if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js");
}
</script>

</body>
</html>
