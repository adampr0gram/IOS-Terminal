<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>iOS Terminal</title>

<link rel="manifest" href="/manifest.json">

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="/icons/192.png">

<!-- Xterm -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css">
<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>

<style>
    html, body {
        margin: 0;
        padding: env(safe-area-inset-top) env(safe-area-inset-right)
                 env(safe-area-inset-bottom) env(safe-area-inset-left);
        width: 100%;
        height: 100%;
        background: #000000;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    #terminal {
        width: 100%;
        height: 100%;
    }

    /* Permission Popup */
    #permissionPopup {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    #popupBox {
        background: #0d0d0d;
        padding: 22px;
        border-radius: 10px;
        border: 1px solid #333;
        width: 280px;
        text-align: center;
        color: #00ff55;
    }
    #chooseFolder {
        margin-top: 12px;
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: none;
        background: #00cc44;
        color: black;
        font-weight: 600;
        font-size: 16px;
    }
</style>
</head>
<body>

<div id="terminal"></div>

<div id="permissionPopup">
    <div id="popupBox">
        <h3>Folder Access</h3>
        <p>Select a folder so commands can read/write files.</p>
        <button id="chooseFolder">Choose Folder</button>
    </div>
</div>

<script>
/* Terminal Initialization */
const term = new Terminal({
    theme: {
        background: "#000000",
        foreground: "#00ff55",   // Green text
        cursor: "#00ff55"
    },
    fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
    fontSize: 14,                // Smaller font size
    cursorBlink: true,
    lineHeight: 1.15
});

let dirHandle = null;
let buffer = "";

term.open(document.getElementById("terminal"));
term.writeln("iOS Terminal Ready\n");
term.write("$ ");

/* Restore Folder Access */
(async () => {
    const saved = localStorage.getItem("dir_saved");
    if (saved) {
        try { dirHandle = await window.showDirectoryPicker(); } catch {}
    }
    if (dirHandle) {
        document.getElementById("permissionPopup").style.display = "none";
        term.writeln("Folder permission restored.");
        term.write("$ ");
    } else {
        term.writeln("Waiting for folder permission...");
    }
})();

/* Folder Picker */
document.getElementById("chooseFolder").onclick = async () => {
    try {
        dirHandle = await window.showDirectoryPicker();
        await dirHandle.requestPermission({ mode: "readwrite" });
        localStorage.setItem("dir_saved", "yes");
        document.getElementById("permissionPopup").style.display = "none";
        term.writeln("\nFolder selected.");
        term.write("$ ");
    } catch {
        term.writeln("\nPermission denied.");
        term.write("$ ");
    }
};

/* Input Handling */
term.onData(data => {
    if (data === "\r") {
        const cmd = buffer.trim();
        buffer = "";
        term.write("\n");
        handleCommand(cmd);
        term.write("\n$ ");
    } else if (data === "\u007F") {
        if (buffer.length) {
            buffer = buffer.slice(0, -1);
            term.write("\b \b");
        }
    } else {
        buffer += data;
        term.write(data);
    }
});

/* REAL PING */
async function realPing(host) {
    const url = host.startsWith("http") ? host : `https://${host}`;
    const start = performance.now();
    try {
        await fetch(url, { mode: "no-cors" });
        const time = Math.round(performance.now() - start);
        return `Reply from ${host}: time=${time}ms`;
    } catch {
        return `Request timed out to ${host}`;
    }
}

/* Command Engine */
async function handleCommand(cmd) {
    if (!cmd) return;

    const [base, ...args] = cmd.split(" ");

    switch (base) {
        case "help":
            term.writeln("Commands:");
            term.writeln(" help, ls/dir, cd, mkdir, rmdir, del, cls");
            term.writeln(" spec, echo, ping, web, credits, run, base64en, exit");
            break;

        case "cls":
            term.clear();
            break;

        case "ls":
        case "dir":
            if (!dirHandle) return term.writeln("No folder selected.");
            for await (const entry of dirHandle.values()) {
                term.writeln(entry.name);
            }
            break;

        case "cd":
            term.writeln("(cd is simulated only)");
            break;

        case "mkdir":
            if (!args[0]) return term.writeln("Usage: mkdir <name>");
            await dirHandle.getDirectoryHandle(args[0], { create: true });
            term.writeln("Folder created.");
            break;

        case "rmdir":
            if (!args[0]) return term.writeln("Usage: rmdir <name>");
            await dirHandle.removeEntry(args[0], { recursive: true });
            term.writeln("Folder removed.");
            break;

        case "del":
            if (!args[0]) return term.writeln("Usage: del <file>");
            await dirHandle.removeEntry(args[0]);
            term.writeln("File deleted.");
            break;

        case "echo":
            term.writeln(args.join(" "));
            break;

        case "web":
            if (!args[0]) return term.writeln("Usage: web <url>");
            window.open(args[0], "_blank");
            term.writeln("Opened " + args[0]);
            break;

        case "ping":
            if (!args[0]) return term.writeln("Usage: ping <host>");
            term.writeln("Pinging " + args[0] + "...");
            const pingReply = await realPing(args[0]);
            term.writeln(pingReply);
            break;

        case "spec":
            term.writeln("Device: iOS WebKit");
            term.writeln("UserAgent: " + navigator.userAgent);
            term.writeln("Cores: " + navigator.hardwareConcurrency);
            break;

        case "credits":
            term.writeln("Adam T. Nassar");
            break;

        case "run":
            term.writeln("CIPT scripting coming soon!");
            break;

        case "base64en":
            term.writeln("Base64 encoder coming soon!");
            break;

        case "exit":
            term.writeln("Goodbye!");
            break;

        default:
            term.writeln("Unknown command: " + base);
    }
}

/* Register Service Worker */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js");
}
</script>

</body>
</html>
